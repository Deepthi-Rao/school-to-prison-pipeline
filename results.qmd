# Results

In order to contextualize disciplinary rates across the country to spot outlier states, the data was converted from raw discipline counts into an overall proportion: total disciplinary actions divided by total enrollment. The below is standardized in this way so that states would be directly comparable. A big state like Texas would have more disciplinary actions than a small state like Vermont, simply because it has more students. If the data was not standardized in this way the overall interpretation would have been heavily skewed.
```{r}
# Install if needed:
# install.packages(c("readxl", "dplyr", "ggplot2", "stringr", "purrr"))

library(readxl)
library(dplyr)
library(ggplot2)
library(stringr)
library(purrr)

# Folder where all your state files live
# e.g. "data/CRDC_2020-21_XX.xlsx" for each state
data_dir <- "./data/2020-2021"  # <-- CHANGE THIS

# List all state Excel files
files <- list.files(
  data_dir,
  pattern = "CRDC_2020-21_.*\\.xlsx$",
  full.names = TRUE
)
options(readxl.quiet = TRUE)

```

```{r}
disc_cols <- c(
  # Corporal punishment
  "TOT_DISCWODIS_CORP_M", "TOT_DISCWODIS_CORP_F",
  "TOT_DISCWDIS_CORP_IDEA_M", "TOT_DISCWDIS_CORP_IDEA_F",
  
  # Expulsions (with/without services, zero-tolerance, etc.)
  "TOT_DISCWODIS_EXPWE_M", "TOT_DISCWODIS_EXPWE_F",
  "TOT_DISCWDIS_EXPWE_IDEA_M", "TOT_DISCWDIS_EXPWE_IDEA_F",
  "TOT_DISCWODIS_EXPWOE_M", "TOT_DISCWODIS_EXPWOE_F",
  "TOT_DISCWDIS_EXPWOE_IDEA_M", "TOT_DISCWDIS_EXPWOE_IDEA_F",
  "TOT_DISCWODIS_EXPZT_M", "TOT_DISCWODIS_EXPZT_F",
  "TOT_DISCWDIS_EXPZT_IDEA_M", "TOT_DISCWDIS_EXPZT_IDEA_F",
  
  # Referrals to law enforcement
  "TOT_DISCWODIS_REF_M", "TOT_DISCWODIS_REF_F",
  "TOT_DISCWDIS_REF_IDEA_M", "TOT_DISCWDIS_REF_IDEA_F",
  
  # School-related arrests
  "TOT_DISCWODIS_ARR_M", "TOT_DISCWODIS_ARR_F",
  "TOT_DISCWDIS_ARR_IDEA_M", "TOT_DISCWDIS_ARR_IDEA_F",
  
  # In-school suspension
  "TOT_DISCWODIS_ISS_M", "TOT_DISCWODIS_ISS_F",
  "TOT_DISCWDIS_ISS_IDEA_M", "TOT_DISCWDIS_ISS_IDEA_F",
  
  # Single out-of-school suspension
  "TOT_DISCWODIS_SINGOOS_M", "TOT_DISCWODIS_SINGOOS_F",
  "TOT_DISCWDIS_SINGOOS_IDEA_M", "TOT_DISCWDIS_SINGOOS_IDEA_F",
  
  # Multiple out-of-school suspensions
  "TOT_DISCWODIS_MULTOOS_M", "TOT_DISCWODIS_MULTOOS_F",
  "TOT_DISCWDIS_MULTOOS_IDEA_M", "TOT_DISCWDIS_MULTOOS_IDEA_F",
  
  # Transfers to alternative schools
  "TOT_DISCWODIS_TFRALT_M", "TOT_DISCWODIS_TFRALT_F",
  "TOT_DISCWDIS_TFRALT_IDEA_M", "TOT_DISCWDIS_TFRALT_IDEA_F"
)
```

```{r}
library(readxl)
library(dplyr)
library(stringr)
library(purrr)
library(tibble)

race_table <- tibble(
  race_code  = c("AM", "AS", "BL", "HI", "HP", "WH", "TR"),
  race_label = c(
    "Am. Indian / Alaska Native",
    "Asian",
    "Black or African American",
    "Hispanic/Latino",
    "Native Hawaiian / Pacific Islander",
    "White",
    "Two or more races"
  )
)

compute_state_and_state_race_metrics <- function(path, race_table) {
  df <- suppressMessages(readxl::read_excel(path, sheet = 1))
  fname <- basename(path)
  
  state_code <- if ("LEA_STATE" %in% names(df)) {
    as.character(df$LEA_STATE[1])
  } else {
    m <- stringr::str_match(fname, "CRDC_2020-21_([A-Z]{2})\\.xlsx")
    if (!is.na(m[1, 2])) m[1, 2] else fname
  }
  
  df_num <- df %>%
    dplyr::mutate(dplyr::across(dplyr::everything(),
                                ~ suppressWarnings(as.numeric(.))))
  df_num[df_num < 0] <- NA
  
  ## ---------- A. OVERALL STATE METRICS ----------
  if (all(c("TOT_ENR_M", "TOT_ENR_F") %in% names(df_num))) {
    enr_all <- df_num$TOT_ENR_M + df_num$TOT_ENR_F
  } else {
    enr_cols_all <- grep("^SCH_ENR_.*_[MF]$", names(df_num), value = TRUE)
    enr_all <- if (length(enr_cols_all) > 0) {
      rowSums(df_num[, enr_cols_all, drop = FALSE], na.rm = TRUE)
    } else {
      rep(NA_real_, nrow(df_num))
    }
  }
  
  # discipline bucket = ISS + single OSS + multiple OSS
  disc_cols_all <- grep(
    "^SCH_(DISCWODIS|DISCWDIS)_(ISS|SINGOOS|MULTOOS)_",
    names(df_num),
    value = TRUE,
    perl = TRUE
  )
  disc_all <- if (length(disc_cols_all) > 0) {
    rowSums(df_num[, disc_cols_all, drop = FALSE], na.rm = TRUE)
  } else {
    rep(NA_real_, nrow(df_num))
  }
  
  total_students_state <- sum(enr_all,  na.rm = TRUE)
  total_actions_state  <- sum(disc_all, na.rm = TRUE)
  
  rate_per_state <- ifelse(
    total_students_state > 0,
    total_actions_state / total_students_state,
    NA_real_
  )
  
  state_data <- tibble::tibble(
    state          = state_code,
    total_students = total_students_state,
    total_actions  = total_actions_state,
    rate_per       = rate_per_state
  )
  
  ## ---------- B. STATE × RACE METRICS ----------
  race_list <- lapply(race_table$race_code, function(race) {
    # enrollment for this race
    enr_cols_r <- grep(
      paste0("^SCH_ENR_", race, "_[MF]$"),
      names(df_num),
      value = TRUE
    )
    
    # discipline (ISS + single OSS + multi OSS) for this race
    disc_cols_r <- grep(
      paste0("^SCH_(DISCWODIS|DISCWDIS)_(ISS|SINGOOS|MULTOOS)_.*_", race, "_[MF]$"),
      names(df_num),
      value = TRUE,
      perl = TRUE
    )
    
    # NEW: law-enforcement referrals for this race
    ref_cols_r <- grep(
      paste0("^SCH_(DISCWODIS|DISCWDIS)_REF_.*_", race, "_[MF]$"),
      names(df_num),
      value = TRUE,
      perl = TRUE
    )
    
    if (length(enr_cols_r) == 0) {
      return(tibble::tibble(
        state               = state_code,
        race_code           = race,
        total_students_race = NA_real_,
        total_actions_race  = NA_real_,
        rate_per_race       = NA_real_,
        total_ref_race      = NA_real_,   # NEW
        ref_per_race        = NA_real_    # NEW
      ))
    }
    
    enr_r  <- rowSums(df_num[, enr_cols_r,  drop = FALSE], na.rm = TRUE)
    
    disc_r <- if (length(disc_cols_r) > 0) {
      rowSums(df_num[, disc_cols_r, drop = FALSE], na.rm = TRUE)
    } else {
      rep(NA_real_, nrow(df_num))
    }
    
    # NEW: referral counts
    ref_r <- if (length(ref_cols_r) > 0) {
      rowSums(df_num[, ref_cols_r, drop = FALSE], na.rm = TRUE)
    } else {
      rep(NA_real_, nrow(df_num))
    }
    
    total_students_race <- sum(enr_r,  na.rm = TRUE)
    total_actions_race  <- sum(disc_r, na.rm = TRUE)
    total_ref_race      <- sum(ref_r,  na.rm = TRUE)  # NEW
    
    rate_per_race <- ifelse(
      total_students_race > 0,
      total_actions_race / total_students_race,
      NA_real_
    )
    
    ref_per_race <- ifelse(                      # NEW
      total_students_race > 0,
      total_ref_race / total_students_race,
      NA_real_
    )
    
    tibble::tibble(
      state               = state_code,
      race_code           = race,
      total_students_race = total_students_race,
      total_actions_race  = total_actions_race,
      rate_per_race       = rate_per_race,
      total_ref_race      = total_ref_race,      # NEW
      ref_per_race        = ref_per_race        # NEW
    )
  })
  
  state_race_data <- dplyr::bind_rows(race_list)
  
  list(
    state_data      = state_data,
    state_race_data = state_race_data
  )
}


```


```{r}
results <- purrr::map(files, compute_state_and_state_race_metrics, race_table = race_table)

# overall-by-state
state_data <- bind_rows(lapply(results, `[[`, "state_data"))

# state × race
state_race_rates <- bind_rows(lapply(results, `[[`, "state_race_data")) %>%
  left_join(race_table, by = "race_code")
```

```{r}
library(dplyr)
library(ggplot2)
library(scales)

plot_df <- state_data %>%
  filter(total_students > 0, !is.na(rate_per))

ggplot(plot_df, aes(x = rate_per)) +
  # histogram (as density)
  geom_histogram(
    aes(y = ..density..),
    bins = 20,
    color = "black",
    fill  = "grey80"
  ) +
  # purple density curve
  geom_density(
    linewidth = 1,
    color = "purple"
  ) +
  scale_x_continuous(
    "Disciplinary actions per student",
    labels = percent_format(accuracy = 0.1)
  ) +
  labs(
    y = "Density",
    title = "Distribution of Discipline Rates Across States"
  ) +
  theme_minimal()

```


The histogram above plots the distribution of these discipline rates by number of density of states that fall in this range. A density curve was overlaid on top to make the overall shape of the distribution clear. This distribution is clearly right skewed; most states cluster at a relatively low disciplinary rate, while a smaller number of states stretch out toward the higher rates on the right. This skewness means the mean is pulled upward by a handful of high-discipline states, and the average state is less punitive on average. It also gives a natural way to define and study outliers; states that sit far out in the long right tail well above where most of the density is concentrated are those with unusually high levels of disciplinary action relative to their student population.

```{r}
library(dplyr)
library(ggplot2)
library(scales)

# state_data: state, total_students, total_actions, rate_per
state_disc <- state_data %>%
  filter(total_students > 0, !is.na(rate_per)) %>%
  mutate(
    state_full = case_when(
      state %in% state.abb ~ state.name[match(state, state.abb)],
      state == "DC"        ~ "District of Columbia",
      state == "PR"        ~ "Puerto Rico",
      TRUE                 ~ state
    )
  )
# 2. Cleveland dot plot with purple → yellow color scale
ggplot(state_disc,
       aes(x = reorder(state_full, rate_per),
           y = rate_per)) +
  # stem from 0 to each point
  geom_segment(aes(xend = state_full, y = 0, yend = rate_per),
               color = "grey80") +
  # dot, colored by discipline rate
  geom_point(aes(color = rate_per), size = 3) +
  coord_flip() +
  scale_y_continuous(
    labels = percent_format(accuracy = 0.1),
    name   = "Disciplinary Action Rate"
  ) +
  scale_color_viridis_c(
    option = "C",  # purple → yellow
    labels = percent_format(accuracy = 0.1),
    name   = "Discipline Rate"
  ) +
  labs(
    x = "State",
    title = "Which states enforce the most disciplinary measures?"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right"
  )


```

```{r}
library(dplyr)
library(ggplot2)
library(maps)

# 1. Prepare state data with full names and a 'region' column
state_data_map <- state_data %>%
  filter(total_students > 0, !is.na(rate_per)) %>%
  mutate(
    state_full = case_when(
      state %in% state.abb ~ state.name[match(state, state.abb)],
      state == "DC"        ~ "District of Columbia",
      state == "PR"        ~ "Puerto Rico",
      TRUE                 ~ state
    ),
    region = tolower(state_full)
  )

# 2. Get US state polygons
us_states <- map_data("state")   # has column 'region' with lowercase state names

# 3. Join polygons with your rates
map_df <- us_states %>%
  left_join(state_data_map, by = "region")

# 4. Choropleth: discipline rate per 1,000 students
ggplot(map_df, aes(x = long, y = lat, group = group, fill = rate_per)) +
  geom_polygon(color = "white", linewidth = 0.2) +
  coord_fixed(1.3) +
  scale_fill_viridis_c(
    option = "C",
    na.value = "grey90",
    name = "Disciplinary Action Rate "
  ) +
  labs(
    title = "Disciplinary Actions Rate by State",
    x = NULL,
    y = NULL
  ) +
  theme_minimal() +
  theme(
    axis.text  = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank()
  )


```

```{r}
library(dplyr)
library(ggplot2)
library(maps)
library(scales)

# 1. Prep race-level data (NO filtering!)
state_race_map <- state_race_rates %>%
  mutate(
    state_full = case_when(
      state %in% state.abb ~ state.name[match(state, state.abb)],
      state == "DC"        ~ "District of Columbia",
      state == "PR"        ~ "Puerto Rico",
      TRUE                 ~ state
    ),
    region = tolower(state_full)
  )

# 2. Base US polygons
us_states <- map_data("state")

# 3. Join polygons with race-level rates
map_race_df <- us_states %>%
  left_join(state_race_map, by = "region") %>%
  # Only drop polygons where we *never* had a race (join failed completely)
  filter(!is.na(race_label))

# 4. Faceted choropleth by race
ggplot(
  map_race_df,
  aes(x = long, y = lat, group = group, fill = rate_per_race)
) +
  geom_polygon(color = "white", linewidth = 0.2) +
  coord_fixed(1.3) +
  facet_wrap(~ race_label) +
  scale_fill_viridis_c(
    option = "C",
    na.value = "grey90",                      # states with no data for that race = grey
    labels = percent_format(accuracy = 0.1),
    name = "Discipline rate"
  ) +
  labs(
    title = "Disciplinary Actions per Student by State\nFaceted by Race",
    x = NULL,
    y = NULL
  ) +
  theme_minimal() +
  theme(
    axis.text  = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    strip.text = element_text(face = "bold")
  )

```

```{r}
library(dplyr)
library(ggplot2)
library(maps)
library(scales)

# 1. Prep race-level data (keep rows even if ref_per_race is NA)
state_race_map <- state_race_rates %>%
  mutate(
    state_full = case_when(
      state %in% state.abb ~ state.name[match(state, state.abb)],
      state == "DC"        ~ "District of Columbia",
      state == "PR"        ~ "Puerto Rico",
      TRUE                 ~ state
    ),
    region = tolower(state_full)
  )

# 2. Base US polygons
us_states <- map_data("state")

# 3. Join polygons with race-level referral rates
map_race_df <- us_states %>%
  left_join(state_race_map, by = "region") %>%
  # only drop polygons that never matched any race at all
  filter(!is.na(race_label))

# 4. Faceted choropleth: referrals per student, by race
ggplot(
  map_race_df,
  aes(x = long, y = lat, group = group, fill = ref_per_race)
) +
  geom_polygon(color = "white", linewidth = 0.2) +
  coord_fixed(1.3) +
  facet_wrap(~ race_label) +
  scale_fill_viridis_c(
    option = "C",
    na.value = "grey90",                        # states with no data for that race = grey
    labels = percent_format(accuracy = 0.1),
    name   = "Referral rate"
  ) +
  labs(
    title = "Referrals to Law Enforcement Rate Faceted by Race",
    x = NULL,
    y = NULL
  ) +
  theme_minimal() +
  theme(
    axis.text  = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    strip.text = element_text(face = "bold")
  )

```

```{r}
library(dplyr)
library(ggplot2)
library(scales)

reg_df <- state_race_rates %>%
  filter(
    total_students_race >= 100,
    total_actions_race > 0,
    !is.na(rate_per_race),
    !is.na(total_ref_race)
  ) %>%
  mutate(ref_per_disc = total_ref_race / total_actions_race) %>%
  # need strictly positive values for log scale
  filter(rate_per_race > 0, ref_per_disc > 0)

ggplot(reg_df,
       aes(x = rate_per_race, y = ref_per_disc)) +
  geom_point(alpha = 0.6) +
  scale_x_log10(
    "Discipline rate (per student, log10)",
    labels = percent_format(accuracy = 0.1)
  ) +
  scale_y_log10(
    "Referrals per disciplinary action (log10)",
    labels = percent_format(accuracy = 0.1)
  ) +
  facet_wrap(~ race_label) +   # <-- no `scales = "free"`
  labs(
    title = "Among disciplined students, who gets referred?",
    subtitle = "Each point = state × race; same log scales in every panel"
  ) +
  theme_minimal()



```

```{r}
library(readxl)
library(dplyr)
library(stringr)
library(tidyr)

race_table <- tibble::tibble(
  race_code  = c("AM", "AS", "BL", "HI", "HP", "WH", "TR"),
  race_label = c(
    "Am. Indian / Alaska Native",
    "Asian",
    "Black or African American",
    "Hispanic/Latino",
    "Native Hawaiian / Pacific Islander",
    "White",
    "Two or more races"
  )
)

compute_state_race_outcomes <- function(path, race_table) {
  df <- suppressMessages(readxl::read_excel(path, sheet = 1))
  fname <- basename(path)
  
  # --- state code from LEA_STATE or filename ---
  state_code <- if ("LEA_STATE" %in% names(df)) {
    as.character(df$LEA_STATE[1])
  } else {
    m <- stringr::str_match(fname, "CRDC_2020-21_([A-Z]{2})\\.xlsx")
    if (!is.na(m[1, 2])) m[1, 2] else fname
  }
  
  # numeric version, negatives -> NA
  df_num <- df %>%
    mutate(across(everything(), ~ suppressWarnings(as.numeric(.))))
  df_num[df_num < 0] <- NA
  
  # ---- loop over races ----
  res_list <- lapply(race_table$race_code, function(race) {
    ## Enrollment for this race
    enr_cols_r <- grep(
      paste0("^SCH_ENR_", race, "_[MF]$"),
      names(df_num),
      value = TRUE
    )
    
    ## Out-of-school suspensions: single + multiple
    oss_cols_r <- grep(
      paste0("^SCH_(DISCWODIS|DISCWDIS)_(SINGOOS|MULTOOS)_.*_", race, "_[MF]$"),
      names(df_num),
      value = TRUE,
      perl = TRUE
    )
    
    ## Expulsions / alt placements
    # (patterns may vary a bit; this grabs common EXP/ALTR-style fields)
    exp_cols_r <- grep(
      paste0("^SCH_(DISCWODIS|DISCWDIS)_(EXP|EXPEL|ALT|ALTR).*_", race, "_[MF]$"),
      names(df_num),
      value = TRUE,
      perl = TRUE
    )
    
    ## Justice: referrals + arrests
    justice_cols_r <- grep(
      paste0("^SCH_(DISCWODIS|DISCWDIS)_(REF|ARR)_.*_", race, "_[MF]$"),
      names(df_num),
      value = TRUE,
      perl = TRUE
    )
    
    # if no enrollment columns, nothing to compute
    if (length(enr_cols_r) == 0) {
      return(tibble::tibble(
        state               = state_code,
        race_code           = race,
        total_students_race = NA_real_,
        oss_count           = NA_real_,
        exp_count           = NA_real_,
        justice_count       = NA_real_,
        oss_per_race        = NA_real_,
        exp_per_race        = NA_real_,
        justice_per_race    = NA_real_
      ))
    }
    
    enr_r <- rowSums(df_num[, enr_cols_r, drop = FALSE], na.rm = TRUE)
    
    oss_r <- if (length(oss_cols_r) > 0) {
      rowSums(df_num[, oss_cols_r, drop = FALSE], na.rm = TRUE)
    } else rep(NA_real_, nrow(df_num))
    
    exp_r <- if (length(exp_cols_r) > 0) {
      rowSums(df_num[, exp_cols_r, drop = FALSE], na.rm = TRUE)
    } else rep(NA_real_, nrow(df_num))
    
    justice_r <- if (length(justice_cols_r) > 0) {
      rowSums(df_num[, justice_cols_r, drop = FALSE], na.rm = TRUE)
    } else rep(NA_real_, nrow(df_num))
    
    total_students_race <- sum(enr_r, na.rm = TRUE)
    oss_count           <- sum(oss_r, na.rm = TRUE)
    exp_count           <- sum(exp_r, na.rm = TRUE)
    justice_count       <- sum(justice_r, na.rm = TRUE)
    
    oss_per_race <- ifelse(total_students_race > 0, oss_count      / total_students_race, NA_real_)
    exp_per_race <- ifelse(total_students_race > 0, exp_count      / total_students_race, NA_real_)
    justice_per_race <- ifelse(total_students_race > 0, justice_count / total_students_race, NA_real_)
    
    tibble::tibble(
      state               = state_code,
      race_code           = race,
      total_students_race = total_students_race,
      oss_count           = oss_count,
      exp_count           = exp_count,
      justice_count       = justice_count,
      oss_per_race        = oss_per_race,
      exp_per_race        = exp_per_race,
      justice_per_race    = justice_per_race
    )
  })
  
  dplyr::bind_rows(res_list)
}

```
```{r}
library(purrr)

results_outcomes <- purrr::map_dfr(
  files,
  compute_state_race_outcomes,
  race_table = race_table
)

state_race_outcomes <- results_outcomes %>%
  left_join(race_table, by = "race_code")


```
```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(scales)

pcp_df <- state_race_outcomes %>%
  filter(total_students_race >= 100) %>%        # optional: drop tiny groups
  select(state, race_label,
         oss_per_race, exp_per_race, justice_per_race) %>%
  pivot_longer(
    cols = c(oss_per_race, exp_per_race, justice_per_race),
    names_to = "stage",
    values_to = "rate"
  ) %>%
  mutate(
    stage = factor(
      stage,
      levels = c("oss_per_race", "exp_per_race", "justice_per_race"),
      labels = c("OSS", "Expulsion/Alt", "Justice")
    )
  )
ggplot(pcp_df,
       aes(x = stage, y = rate, group = state)) +
  geom_line(alpha = 0.3) +
  geom_point(alpha = 0.4, size = 0.8) +
  facet_wrap(~ race_label) +
  scale_y_continuous(labels = percent_format(accuracy = 0.1)) +
  labs(
    x = "Stage in pipeline",
    y = "Rate per student",
    title = "Discipline & Justice \"Pipeline\" by State, Faceted by Race",
    subtitle = "Each line = one state"
  ) +
  theme_minimal()


```

```{r}
library(dplyr)
library(ggplot2)
library(scales)

state_ref <- state_race_outcomes %>%
  group_by(state) %>%
  summarise(
    total_students = sum(total_students_race, na.rm = TRUE),
    total_justice  = sum(justice_count,       na.rm = TRUE)
  ) %>%
  ungroup() %>%
  mutate(ref_per = total_justice / total_students)

state_ref_long <- state_ref %>%
  filter(total_students > 0, ref_per > 0) %>%   # remove 0% states
  mutate(
    state_full = case_when(
      state %in% state.abb ~ state.name[match(state, state.abb)],
      state == "DC"        ~ "District of Columbia",
      state == "PR"        ~ "Puerto Rico",
      TRUE                 ~ state
    )
  )

ggplot(state_ref_long,
       aes(x = reorder(state_full, ref_per),
           y = ref_per)) +
  # grey stem from 0 to the value
  geom_segment(aes(xend = state_full, y = 0, yend = ref_per),
               color = "grey80") +
  # dot at the value, colored by rate
  geom_point(aes(color = ref_per), size = 3) +
  coord_flip() +
  scale_y_continuous(labels = percent_format(accuracy = 0.01)) +
  scale_color_viridis_c(
    option = "C",   # yellow ↔ purple
    labels = percent_format(accuracy = 0.01),
    name   = "Referral rate\n(per student)"
  ) +
  labs(
    x = "State",
    y = "Referrals to law enforcement (per student)",
    title = "Which states are most likely to refer students to law enforcement?"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right"
  )



```


```{r}

library(ggplot2)
library(scales)
library(maps)

us_states <- map_data("state")

state_ref_map <- state_ref %>%
  filter(total_students > 0) %>%
  mutate(
    state_full = case_when(
      state %in% state.abb ~ state.name[match(state, state.abb)],
      state == "DC"        ~ "District of Columbia",
      state == "PR"        ~ "Puerto Rico",
      TRUE                 ~ state
    ),
    region = tolower(state_full)
  )
map_df <- us_states %>%
  left_join(state_ref_map, by = "region")

ggplot(map_df,
       aes(x = long, y = lat, group = group, fill = ref_per)) +
  geom_polygon(color = "white", linewidth = 0.2) +
  coord_fixed(1.3) +
  scale_fill_viridis_c(
    option = "C",  # yellow → purple
    labels = percent_format(accuracy = 0.01),
    na.value = "grey90",
    name = "Referral rate\n(per student)"
  ) +
  labs(
    title = "Referrals to Law Enforcement per Student by State",
    x = NULL, y = NULL
  ) +
  theme_minimal() +
  theme(
    axis.text  = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank()
  )

```

```{r}
library(dplyr)
library(ggplot2)
library(maps)
library(scales)

# 1. Prep race-level data for mapping
state_race_map <- state_race_outcomes %>%
  mutate(
    state_full = case_when(
      state %in% state.abb ~ state.name[match(state, state.abb)],
      state == "DC"        ~ "District of Columbia",
      state == "PR"        ~ "Puerto Rico",
      TRUE                 ~ state
    ),
    region = tolower(state_full)
  )

# 2. Base US polygons (lower 48 + AK/HI)
us_states <- map_data("state")

# 3. Join polygons with justice referral rates
map_race_df <- us_states %>%
  left_join(state_race_map, by = "region") %>%
  # keep only polygons that matched some race (no extra NA facet)
  filter(!is.na(race_label))

# 4. Faceted choropleth: referrals per student, by race
ggplot(
  map_race_df,
  aes(x = long, y = lat, group = group, fill = justice_per_race)
) +
  geom_polygon(color = "white", linewidth = 0.2) +
  coord_fixed(1.3) +
  facet_wrap(~ race_label) +
  scale_fill_viridis_c(
    option = "C",
    na.value = "grey90",  # states with no data for that race = grey
    labels = percent_format(accuracy = 0.01),
    name   = "Referral rate\n(per student)"
  ) +
  labs(
    title = "Referrals to Law Enforcement per Student by State\nFaceted by Race",
    x = NULL,
    y = NULL
  ) +
  theme_minimal() +
  theme(
    axis.text  = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    strip.text = element_text(face = "bold")
  )


```


