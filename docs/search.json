[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "School To Prison Pipeline",
    "section": "",
    "text": "1 Introduction\nThe school-to-prison pipeline refers to a set of policies and practices in U.S. school systems that disproportionately push underserved students, especially students of color, out of classrooms and toward the juvenile and criminal justice systems. The pipeline is rooted in our nation’s long history of segregation, inequality, and inequity; it is then reinforced today by disciplinary practices such as frequent suspensions and expulsions for low grade offenses. In this project, I will study the trends that create this pipeline with a focus on racial disparities and regional patterns. Specifically, I will analyze how rates of suspensions, expulsions, involvement of law enforcement, and arrests vary by race and geographic location.",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Introduction</span>"
    ]
  },
  {
    "objectID": "data.html",
    "href": "data.html",
    "title": "2  Data",
    "section": "",
    "text": "https://www.bea.gov/news/2021/gross-domestic-product-state-4th-quarter-2020-and-annual-2020-preliminary",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Data</span>"
    ]
  },
  {
    "objectID": "data.html#missing-value-analysis",
    "href": "data.html#missing-value-analysis",
    "title": "2  Data",
    "section": "2.2 Missing value analysis",
    "text": "2.2 Missing value analysis\nmissing data from 2019-2020 and 2018-2019, figure out why?",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Data</span>"
    ]
  },
  {
    "objectID": "results.html",
    "href": "results.html",
    "title": "3  Results",
    "section": "",
    "text": "Code\n# Install if needed:\n# install.packages(c(\"readxl\", \"dplyr\", \"ggplot2\", \"stringr\", \"purrr\"))\n\nlibrary(readxl)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(stringr)\nlibrary(purrr)\n\n# Folder where all your state files live\n# e.g. \"data/CRDC_2020-21_XX.xlsx\" for each state\ndata_dir &lt;- \"./data/2020-2021\"  # &lt;-- CHANGE THIS\n\n# List all state Excel files\nfiles &lt;- list.files(\n  data_dir,\n  pattern = \"CRDC_2020-21_.*\\\\.xlsx$\",\n  full.names = TRUE\n)\noptions(readxl.quiet = TRUE)\n\n\n\n\nCode\ndisc_cols &lt;- c(\n  # Corporal punishment\n  \"TOT_DISCWODIS_CORP_M\", \"TOT_DISCWODIS_CORP_F\",\n  \"TOT_DISCWDIS_CORP_IDEA_M\", \"TOT_DISCWDIS_CORP_IDEA_F\",\n  \n  # Expulsions (with/without services, zero-tolerance, etc.)\n  \"TOT_DISCWODIS_EXPWE_M\", \"TOT_DISCWODIS_EXPWE_F\",\n  \"TOT_DISCWDIS_EXPWE_IDEA_M\", \"TOT_DISCWDIS_EXPWE_IDEA_F\",\n  \"TOT_DISCWODIS_EXPWOE_M\", \"TOT_DISCWODIS_EXPWOE_F\",\n  \"TOT_DISCWDIS_EXPWOE_IDEA_M\", \"TOT_DISCWDIS_EXPWOE_IDEA_F\",\n  \"TOT_DISCWODIS_EXPZT_M\", \"TOT_DISCWODIS_EXPZT_F\",\n  \"TOT_DISCWDIS_EXPZT_IDEA_M\", \"TOT_DISCWDIS_EXPZT_IDEA_F\",\n  \n  # Referrals to law enforcement\n  \"TOT_DISCWODIS_REF_M\", \"TOT_DISCWODIS_REF_F\",\n  \"TOT_DISCWDIS_REF_IDEA_M\", \"TOT_DISCWDIS_REF_IDEA_F\",\n  \n  # School-related arrests\n  \"TOT_DISCWODIS_ARR_M\", \"TOT_DISCWODIS_ARR_F\",\n  \"TOT_DISCWDIS_ARR_IDEA_M\", \"TOT_DISCWDIS_ARR_IDEA_F\",\n  \n  # In-school suspension\n  \"TOT_DISCWODIS_ISS_M\", \"TOT_DISCWODIS_ISS_F\",\n  \"TOT_DISCWDIS_ISS_IDEA_M\", \"TOT_DISCWDIS_ISS_IDEA_F\",\n  \n  # Single out-of-school suspension\n  \"TOT_DISCWODIS_SINGOOS_M\", \"TOT_DISCWODIS_SINGOOS_F\",\n  \"TOT_DISCWDIS_SINGOOS_IDEA_M\", \"TOT_DISCWDIS_SINGOOS_IDEA_F\",\n  \n  # Multiple out-of-school suspensions\n  \"TOT_DISCWODIS_MULTOOS_M\", \"TOT_DISCWODIS_MULTOOS_F\",\n  \"TOT_DISCWDIS_MULTOOS_IDEA_M\", \"TOT_DISCWDIS_MULTOOS_IDEA_F\",\n  \n  # Transfers to alternative schools\n  \"TOT_DISCWODIS_TFRALT_M\", \"TOT_DISCWODIS_TFRALT_F\",\n  \"TOT_DISCWDIS_TFRALT_IDEA_M\", \"TOT_DISCWDIS_TFRALT_IDEA_F\"\n)\n\n\n\n\nCode\nlibrary(readxl)\nlibrary(dplyr)\nlibrary(stringr)\nlibrary(purrr)\nlibrary(tibble)\n\nrace_table &lt;- tibble(\n  race_code  = c(\"AM\", \"AS\", \"BL\", \"HI\", \"HP\", \"WH\", \"TR\"),\n  race_label = c(\n    \"Am. Indian / Alaska Native\",\n    \"Asian\",\n    \"Black or African American\",\n    \"Hispanic/Latino\",\n    \"Native Hawaiian / Pacific Islander\",\n    \"White\",\n    \"Two or more races\"\n  )\n)\n\ncompute_state_and_state_race_metrics &lt;- function(path, race_table) {\n  df &lt;- suppressMessages(readxl::read_excel(path, sheet = 1))\n  fname &lt;- basename(path)\n  \n  state_code &lt;- if (\"LEA_STATE\" %in% names(df)) {\n    as.character(df$LEA_STATE[1])\n  } else {\n    m &lt;- stringr::str_match(fname, \"CRDC_2020-21_([A-Z]{2})\\\\.xlsx\")\n    if (!is.na(m[1, 2])) m[1, 2] else fname\n  }\n  \n  df_num &lt;- df %&gt;%\n    dplyr::mutate(dplyr::across(dplyr::everything(),\n                                ~ suppressWarnings(as.numeric(.))))\n  df_num[df_num &lt; 0] &lt;- NA\n  \n  ## ---------- A. OVERALL STATE METRICS ----------\n  if (all(c(\"TOT_ENR_M\", \"TOT_ENR_F\") %in% names(df_num))) {\n    enr_all &lt;- df_num$TOT_ENR_M + df_num$TOT_ENR_F\n  } else {\n    enr_cols_all &lt;- grep(\"^SCH_ENR_.*_[MF]$\", names(df_num), value = TRUE)\n    enr_all &lt;- if (length(enr_cols_all) &gt; 0) {\n      rowSums(df_num[, enr_cols_all, drop = FALSE], na.rm = TRUE)\n    } else {\n      rep(NA_real_, nrow(df_num))\n    }\n  }\n  \n  # discipline bucket = ISS + single OSS + multiple OSS\n  disc_cols_all &lt;- grep(\n    \"^SCH_(DISCWODIS|DISCWDIS)_(ISS|SINGOOS|MULTOOS)_\",\n    names(df_num),\n    value = TRUE,\n    perl = TRUE\n  )\n  disc_all &lt;- if (length(disc_cols_all) &gt; 0) {\n    rowSums(df_num[, disc_cols_all, drop = FALSE], na.rm = TRUE)\n  } else {\n    rep(NA_real_, nrow(df_num))\n  }\n  \n  total_students_state &lt;- sum(enr_all,  na.rm = TRUE)\n  total_actions_state  &lt;- sum(disc_all, na.rm = TRUE)\n  \n  rate_per_state &lt;- ifelse(\n    total_students_state &gt; 0,\n    total_actions_state / total_students_state,\n    NA_real_\n  )\n  \n  state_data &lt;- tibble::tibble(\n    state          = state_code,\n    total_students = total_students_state,\n    total_actions  = total_actions_state,\n    rate_per       = rate_per_state\n  )\n  \n  ## ---------- B. STATE × RACE METRICS ----------\n  race_list &lt;- lapply(race_table$race_code, function(race) {\n    # enrollment for this race\n    enr_cols_r &lt;- grep(\n      paste0(\"^SCH_ENR_\", race, \"_[MF]$\"),\n      names(df_num),\n      value = TRUE\n    )\n    \n    # discipline (ISS + single OSS + multi OSS) for this race\n    disc_cols_r &lt;- grep(\n      paste0(\"^SCH_(DISCWODIS|DISCWDIS)_(ISS|SINGOOS|MULTOOS)_.*_\", race, \"_[MF]$\"),\n      names(df_num),\n      value = TRUE,\n      perl = TRUE\n    )\n    \n    # NEW: law-enforcement referrals for this race\n    ref_cols_r &lt;- grep(\n      paste0(\"^SCH_(DISCWODIS|DISCWDIS)_REF_.*_\", race, \"_[MF]$\"),\n      names(df_num),\n      value = TRUE,\n      perl = TRUE\n    )\n    \n    if (length(enr_cols_r) == 0) {\n      return(tibble::tibble(\n        state               = state_code,\n        race_code           = race,\n        total_students_race = NA_real_,\n        total_actions_race  = NA_real_,\n        rate_per_race       = NA_real_,\n        total_ref_race      = NA_real_,   # NEW\n        ref_per_race        = NA_real_    # NEW\n      ))\n    }\n    \n    enr_r  &lt;- rowSums(df_num[, enr_cols_r,  drop = FALSE], na.rm = TRUE)\n    \n    disc_r &lt;- if (length(disc_cols_r) &gt; 0) {\n      rowSums(df_num[, disc_cols_r, drop = FALSE], na.rm = TRUE)\n    } else {\n      rep(NA_real_, nrow(df_num))\n    }\n    \n    # NEW: referral counts\n    ref_r &lt;- if (length(ref_cols_r) &gt; 0) {\n      rowSums(df_num[, ref_cols_r, drop = FALSE], na.rm = TRUE)\n    } else {\n      rep(NA_real_, nrow(df_num))\n    }\n    \n    total_students_race &lt;- sum(enr_r,  na.rm = TRUE)\n    total_actions_race  &lt;- sum(disc_r, na.rm = TRUE)\n    total_ref_race      &lt;- sum(ref_r,  na.rm = TRUE)  # NEW\n    \n    rate_per_race &lt;- ifelse(\n      total_students_race &gt; 0,\n      total_actions_race / total_students_race,\n      NA_real_\n    )\n    \n    ref_per_race &lt;- ifelse(                      # NEW\n      total_students_race &gt; 0,\n      total_ref_race / total_students_race,\n      NA_real_\n    )\n    \n    tibble::tibble(\n      state               = state_code,\n      race_code           = race,\n      total_students_race = total_students_race,\n      total_actions_race  = total_actions_race,\n      rate_per_race       = rate_per_race,\n      total_ref_race      = total_ref_race,      # NEW\n      ref_per_race        = ref_per_race        # NEW\n    )\n  })\n  \n  state_race_data &lt;- dplyr::bind_rows(race_list)\n  \n  list(\n    state_data      = state_data,\n    state_race_data = state_race_data\n  )\n}\n\n\n\n\nCode\nresults &lt;- purrr::map(files, compute_state_and_state_race_metrics, race_table = race_table)\n\n# overall-by-state\nstate_data &lt;- bind_rows(lapply(results, `[[`, \"state_data\"))\n\n# state × race\nstate_race_rates &lt;- bind_rows(lapply(results, `[[`, \"state_race_data\")) %&gt;%\n  left_join(race_table, by = \"race_code\")\n\n\n\n\nCode\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(scales)\n\nhist_df &lt;- state_data %&gt;%\n  filter(total_students &gt; 0, !is.na(rate_per))\n\nggplot(hist_df, aes(x = rate_per)) +\n  geom_histogram(bins = 20, color = \"white\") +\n  scale_x_continuous(\n    \"Disciplinary actions per student\",\n    labels = percent_format(accuracy = 0.1)\n  ) +\n  labs(\n    y = \"Number of states\",\n    title = \"Distribution of discipline rates across states\"\n  ) +\n  theme_minimal()\n\n\n\n\n\n\n\n\n\nCode\nggplot(hist_df, aes(x = rate_per)) +\n  geom_density(fill = \"grey60\", alpha = 0.7) +\n  scale_x_continuous(\n    \"Disciplinary actions per student\",\n    labels = percent_format(accuracy = 0.1)\n  ) +\n  labs(\n    y = \"Density\",\n    title = \"Density of discipline rates across states\"\n  ) +\n  theme_minimal()\n\n\n\n\n\n\n\n\n\nCode\nhist_df &lt;- state_data %&gt;%\n  filter(total_students &gt; 0, !is.na(rate_per))\n\n\n\n\nCode\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(scales)\n\n# 1. Build state-level referral rate from state_race_rates\nstate_ref &lt;- state_race_rates %&gt;%\n  group_by(state) %&gt;%\n  summarise(\n    total_students = sum(total_students_race, na.rm = TRUE),\n    total_ref      = sum(total_ref_race,      na.rm = TRUE)\n  ) %&gt;%\n  ungroup() %&gt;%\n  mutate(ref_per = total_ref / total_students)\n\n# 2. Clean up + drop 0% states\nstate_ref_long &lt;- state_ref %&gt;%\n  filter(total_students &gt; 0, ref_per &gt; 0) %&gt;%   # remove 0% + empty states\n  mutate(\n    state_full = case_when(\n      state %in% state.abb ~ state.name[match(state, state.abb)],\n      state == \"DC\"        ~ \"District of Columbia\",\n      state == \"PR\"        ~ \"Puerto Rico\",\n      TRUE                 ~ state\n    )\n  )\n\n# 3. Cleveland dot plot\nggplot(state_ref_long,\n       aes(x = reorder(state_full, ref_per),\n           y = ref_per)) +\n  # grey stem from 0 to the value\n  geom_segment(aes(xend = state_full, y = 0, yend = ref_per),\n               color = \"grey80\") +\n  # dot at the value, colored by rate\n  geom_point(aes(color = ref_per), size = 3) +\n  coord_flip() +\n  scale_y_continuous(labels = percent_format(accuracy = 0.01)) +\n  scale_color_viridis_c(\n    option = \"C\",  # yellow ↔ purple\n    labels = percent_format(accuracy = 0.01),\n    name   = \"Referral rate\\n(per student)\"\n  ) +\n  labs(\n    x = \"State\",\n    y = \"Referrals to law enforcement (per student)\",\n    title = \"Which states are most likely to refer students to law enforcement?\"\n  ) +\n  theme_minimal() +\n  theme(\n    legend.position = \"right\"\n  )\n\n\n\n\n\n\n\n\n\n\n\nCode\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(maps)\n\n# 1. Prepare state data with full names and a 'region' column\nstate_data_map &lt;- state_data %&gt;%\n  filter(total_students &gt; 0, !is.na(rate_per)) %&gt;%\n  mutate(\n    state_full = case_when(\n      state %in% state.abb ~ state.name[match(state, state.abb)],\n      state == \"DC\"        ~ \"District of Columbia\",\n      state == \"PR\"        ~ \"Puerto Rico\",\n      TRUE                 ~ state\n    ),\n    region = tolower(state_full)\n  )\n\n# 2. Get US state polygons\nus_states &lt;- map_data(\"state\")   # has column 'region' with lowercase state names\n\n# 3. Join polygons with your rates\nmap_df &lt;- us_states %&gt;%\n  left_join(state_data_map, by = \"region\")\n\n# 4. Choropleth: discipline rate per 1,000 students\nggplot(map_df, aes(x = long, y = lat, group = group, fill = rate_per)) +\n  geom_polygon(color = \"white\", linewidth = 0.2) +\n  coord_fixed(1.3) +\n  scale_fill_viridis_c(\n    option = \"C\",\n    na.value = \"grey90\",\n    name = \"Disciplinary actions\\nper 1,000 students\"\n  ) +\n  labs(\n    title = \"Disciplinary Actions per 1,000 Students by State\",\n    x = NULL,\n    y = NULL\n  ) +\n  theme_minimal() +\n  theme(\n    axis.text  = element_blank(),\n    axis.ticks = element_blank(),\n    panel.grid = element_blank()\n  )\n\n\n\n\n\n\n\n\n\n\n\nCode\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(maps)\nlibrary(scales)\n\n# 1. Prep race-level data (NO filtering!)\nstate_race_map &lt;- state_race_rates %&gt;%\n  mutate(\n    state_full = case_when(\n      state %in% state.abb ~ state.name[match(state, state.abb)],\n      state == \"DC\"        ~ \"District of Columbia\",\n      state == \"PR\"        ~ \"Puerto Rico\",\n      TRUE                 ~ state\n    ),\n    region = tolower(state_full)\n  )\n\n# 2. Base US polygons\nus_states &lt;- map_data(\"state\")\n\n# 3. Join polygons with race-level rates\nmap_race_df &lt;- us_states %&gt;%\n  left_join(state_race_map, by = \"region\") %&gt;%\n  # Only drop polygons where we *never* had a race (join failed completely)\n  filter(!is.na(race_label))\n\n# 4. Faceted choropleth by race\nggplot(\n  map_race_df,\n  aes(x = long, y = lat, group = group, fill = rate_per_race)\n) +\n  geom_polygon(color = \"white\", linewidth = 0.2) +\n  coord_fixed(1.3) +\n  facet_wrap(~ race_label) +\n  scale_fill_viridis_c(\n    option = \"C\",\n    na.value = \"grey90\",                      # states with no data for that race = grey\n    labels = percent_format(accuracy = 0.1),\n    name = \"Discipline rate\"\n  ) +\n  labs(\n    title = \"Disciplinary Actions per Student by State\\nFaceted by Race\",\n    x = NULL,\n    y = NULL\n  ) +\n  theme_minimal() +\n  theme(\n    axis.text  = element_blank(),\n    axis.ticks = element_blank(),\n    panel.grid = element_blank(),\n    strip.text = element_text(face = \"bold\")\n  )\n\n\n\n\n\n\n\n\n\n\n\nCode\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(maps)\nlibrary(scales)\n\n# 1. Prep race-level data (keep rows even if ref_per_race is NA)\nstate_race_map &lt;- state_race_rates %&gt;%\n  mutate(\n    state_full = case_when(\n      state %in% state.abb ~ state.name[match(state, state.abb)],\n      state == \"DC\"        ~ \"District of Columbia\",\n      state == \"PR\"        ~ \"Puerto Rico\",\n      TRUE                 ~ state\n    ),\n    region = tolower(state_full)\n  )\n\n# 2. Base US polygons\nus_states &lt;- map_data(\"state\")\n\n# 3. Join polygons with race-level referral rates\nmap_race_df &lt;- us_states %&gt;%\n  left_join(state_race_map, by = \"region\") %&gt;%\n  # only drop polygons that never matched any race at all\n  filter(!is.na(race_label))\n\n# 4. Faceted choropleth: referrals per student, by race\nggplot(\n  map_race_df,\n  aes(x = long, y = lat, group = group, fill = ref_per_race)\n) +\n  geom_polygon(color = \"white\", linewidth = 0.2) +\n  coord_fixed(1.3) +\n  facet_wrap(~ race_label) +\n  scale_fill_viridis_c(\n    option = \"C\",\n    na.value = \"grey90\",                        # states with no data for that race = grey\n    labels = percent_format(accuracy = 0.1),\n    name   = \"Referral rate\"\n  ) +\n  labs(\n    title = \"Referrals to Law Enforcement Rate Faceted by Race\",\n    x = NULL,\n    y = NULL\n  ) +\n  theme_minimal() +\n  theme(\n    axis.text  = element_blank(),\n    axis.ticks = element_blank(),\n    panel.grid = element_blank(),\n    strip.text = element_text(face = \"bold\")\n  )\n\n\n\n\n\n\n\n\n\n\n\nCode\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(scales)\n\nreg_df &lt;- state_race_rates %&gt;%\n  filter(\n    total_students_race &gt;= 100,\n    total_actions_race &gt; 0,\n    !is.na(rate_per_race),\n    !is.na(total_ref_race)\n  ) %&gt;%\n  mutate(ref_per_disc = total_ref_race / total_actions_race) %&gt;%\n  # need strictly positive values for log scale\n  filter(rate_per_race &gt; 0, ref_per_disc &gt; 0)\n\nggplot(reg_df,\n       aes(x = rate_per_race, y = ref_per_disc)) +\n  geom_point(alpha = 0.6) +\n  scale_x_log10(\n    \"Discipline rate (per student, log10)\",\n    labels = percent_format(accuracy = 0.1)\n  ) +\n  scale_y_log10(\n    \"Referrals per disciplinary action (log10)\",\n    labels = percent_format(accuracy = 0.1)\n  ) +\n  facet_wrap(~ race_label) +   # &lt;-- no `scales = \"free\"`\n  labs(\n    title = \"Among disciplined students, who gets referred?\",\n    subtitle = \"Each point = state × race; same log scales in every panel\"\n  ) +\n  theme_minimal()\n\n\n\n\n\n\n\n\n\n\n\nCode\nlibrary(readxl)\nlibrary(dplyr)\nlibrary(stringr)\nlibrary(tidyr)\n\nrace_table &lt;- tibble::tibble(\n  race_code  = c(\"AM\", \"AS\", \"BL\", \"HI\", \"HP\", \"WH\", \"TR\"),\n  race_label = c(\n    \"Am. Indian / Alaska Native\",\n    \"Asian\",\n    \"Black or African American\",\n    \"Hispanic/Latino\",\n    \"Native Hawaiian / Pacific Islander\",\n    \"White\",\n    \"Two or more races\"\n  )\n)\n\ncompute_state_race_outcomes &lt;- function(path, race_table) {\n  df &lt;- suppressMessages(readxl::read_excel(path, sheet = 1))\n  fname &lt;- basename(path)\n  \n  # --- state code from LEA_STATE or filename ---\n  state_code &lt;- if (\"LEA_STATE\" %in% names(df)) {\n    as.character(df$LEA_STATE[1])\n  } else {\n    m &lt;- stringr::str_match(fname, \"CRDC_2020-21_([A-Z]{2})\\\\.xlsx\")\n    if (!is.na(m[1, 2])) m[1, 2] else fname\n  }\n  \n  # numeric version, negatives -&gt; NA\n  df_num &lt;- df %&gt;%\n    mutate(across(everything(), ~ suppressWarnings(as.numeric(.))))\n  df_num[df_num &lt; 0] &lt;- NA\n  \n  # ---- loop over races ----\n  res_list &lt;- lapply(race_table$race_code, function(race) {\n    ## Enrollment for this race\n    enr_cols_r &lt;- grep(\n      paste0(\"^SCH_ENR_\", race, \"_[MF]$\"),\n      names(df_num),\n      value = TRUE\n    )\n    \n    ## Out-of-school suspensions: single + multiple\n    oss_cols_r &lt;- grep(\n      paste0(\"^SCH_(DISCWODIS|DISCWDIS)_(SINGOOS|MULTOOS)_.*_\", race, \"_[MF]$\"),\n      names(df_num),\n      value = TRUE,\n      perl = TRUE\n    )\n    \n    ## Expulsions / alt placements\n    # (patterns may vary a bit; this grabs common EXP/ALTR-style fields)\n    exp_cols_r &lt;- grep(\n      paste0(\"^SCH_(DISCWODIS|DISCWDIS)_(EXP|EXPEL|ALT|ALTR).*_\", race, \"_[MF]$\"),\n      names(df_num),\n      value = TRUE,\n      perl = TRUE\n    )\n    \n    ## Justice: referrals + arrests\n    justice_cols_r &lt;- grep(\n      paste0(\"^SCH_(DISCWODIS|DISCWDIS)_(REF|ARR)_.*_\", race, \"_[MF]$\"),\n      names(df_num),\n      value = TRUE,\n      perl = TRUE\n    )\n    \n    # if no enrollment columns, nothing to compute\n    if (length(enr_cols_r) == 0) {\n      return(tibble::tibble(\n        state               = state_code,\n        race_code           = race,\n        total_students_race = NA_real_,\n        oss_count           = NA_real_,\n        exp_count           = NA_real_,\n        justice_count       = NA_real_,\n        oss_per_race        = NA_real_,\n        exp_per_race        = NA_real_,\n        justice_per_race    = NA_real_\n      ))\n    }\n    \n    enr_r &lt;- rowSums(df_num[, enr_cols_r, drop = FALSE], na.rm = TRUE)\n    \n    oss_r &lt;- if (length(oss_cols_r) &gt; 0) {\n      rowSums(df_num[, oss_cols_r, drop = FALSE], na.rm = TRUE)\n    } else rep(NA_real_, nrow(df_num))\n    \n    exp_r &lt;- if (length(exp_cols_r) &gt; 0) {\n      rowSums(df_num[, exp_cols_r, drop = FALSE], na.rm = TRUE)\n    } else rep(NA_real_, nrow(df_num))\n    \n    justice_r &lt;- if (length(justice_cols_r) &gt; 0) {\n      rowSums(df_num[, justice_cols_r, drop = FALSE], na.rm = TRUE)\n    } else rep(NA_real_, nrow(df_num))\n    \n    total_students_race &lt;- sum(enr_r, na.rm = TRUE)\n    oss_count           &lt;- sum(oss_r, na.rm = TRUE)\n    exp_count           &lt;- sum(exp_r, na.rm = TRUE)\n    justice_count       &lt;- sum(justice_r, na.rm = TRUE)\n    \n    oss_per_race &lt;- ifelse(total_students_race &gt; 0, oss_count      / total_students_race, NA_real_)\n    exp_per_race &lt;- ifelse(total_students_race &gt; 0, exp_count      / total_students_race, NA_real_)\n    justice_per_race &lt;- ifelse(total_students_race &gt; 0, justice_count / total_students_race, NA_real_)\n    \n    tibble::tibble(\n      state               = state_code,\n      race_code           = race,\n      total_students_race = total_students_race,\n      oss_count           = oss_count,\n      exp_count           = exp_count,\n      justice_count       = justice_count,\n      oss_per_race        = oss_per_race,\n      exp_per_race        = exp_per_race,\n      justice_per_race    = justice_per_race\n    )\n  })\n  \n  dplyr::bind_rows(res_list)\n}\n\n\n\n\nCode\nlibrary(purrr)\n\nresults_outcomes &lt;- purrr::map_dfr(\n  files,\n  compute_state_race_outcomes,\n  race_table = race_table\n)\n\nstate_race_outcomes &lt;- results_outcomes %&gt;%\n  left_join(race_table, by = \"race_code\")\n\n\n\n\nCode\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(ggplot2)\nlibrary(scales)\n\npcp_df &lt;- state_race_outcomes %&gt;%\n  filter(total_students_race &gt;= 100) %&gt;%        # optional: drop tiny groups\n  select(state, race_label,\n         oss_per_race, exp_per_race, justice_per_race) %&gt;%\n  pivot_longer(\n    cols = c(oss_per_race, exp_per_race, justice_per_race),\n    names_to = \"stage\",\n    values_to = \"rate\"\n  ) %&gt;%\n  mutate(\n    stage = factor(\n      stage,\n      levels = c(\"oss_per_race\", \"exp_per_race\", \"justice_per_race\"),\n      labels = c(\"OSS\", \"Expulsion/Alt\", \"Justice\")\n    )\n  )\nggplot(pcp_df,\n       aes(x = stage, y = rate, group = state)) +\n  geom_line(alpha = 0.3) +\n  geom_point(alpha = 0.4, size = 0.8) +\n  facet_wrap(~ race_label) +\n  scale_y_continuous(labels = percent_format(accuracy = 0.1)) +\n  labs(\n    x = \"Stage in pipeline\",\n    y = \"Rate per student\",\n    title = \"Discipline & Justice \\\"Pipeline\\\" by State, Faceted by Race\",\n    subtitle = \"Each line = one state\"\n  ) +\n  theme_minimal()\n\n\n\n\n\n\n\n\n\n\n\nCode\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(scales)\n\nstate_ref &lt;- state_race_outcomes %&gt;%\n  group_by(state) %&gt;%\n  summarise(\n    total_students = sum(total_students_race, na.rm = TRUE),\n    total_justice  = sum(justice_count,       na.rm = TRUE)\n  ) %&gt;%\n  ungroup() %&gt;%\n  mutate(ref_per = total_justice / total_students)\n\nstate_ref_long &lt;- state_ref %&gt;%\n  filter(total_students &gt; 0, ref_per &gt; 0) %&gt;%   # remove 0% states\n  mutate(\n    state_full = case_when(\n      state %in% state.abb ~ state.name[match(state, state.abb)],\n      state == \"DC\"        ~ \"District of Columbia\",\n      state == \"PR\"        ~ \"Puerto Rico\",\n      TRUE                 ~ state\n    )\n  )\n\nggplot(state_ref_long,\n       aes(x = reorder(state_full, ref_per),\n           y = ref_per)) +\n  # grey stem from 0 to the value\n  geom_segment(aes(xend = state_full, y = 0, yend = ref_per),\n               color = \"grey80\") +\n  # dot at the value, colored by rate\n  geom_point(aes(color = ref_per), size = 3) +\n  coord_flip() +\n  scale_y_continuous(labels = percent_format(accuracy = 0.01)) +\n  scale_color_viridis_c(\n    option = \"C\",   # yellow ↔ purple\n    labels = percent_format(accuracy = 0.01),\n    name   = \"Referral rate\\n(per student)\"\n  ) +\n  labs(\n    x = \"State\",\n    y = \"Referrals to law enforcement (per student)\",\n    title = \"Which states are most likely to refer students to law enforcement?\"\n  ) +\n  theme_minimal() +\n  theme(\n    legend.position = \"right\"\n  )\n\n\n\n\n\n\n\n\n\n\n\nCode\nlibrary(ggplot2)\nlibrary(scales)\nlibrary(maps)\n\nus_states &lt;- map_data(\"state\")\n\nstate_ref_map &lt;- state_ref %&gt;%\n  filter(total_students &gt; 0) %&gt;%\n  mutate(\n    state_full = case_when(\n      state %in% state.abb ~ state.name[match(state, state.abb)],\n      state == \"DC\"        ~ \"District of Columbia\",\n      state == \"PR\"        ~ \"Puerto Rico\",\n      TRUE                 ~ state\n    ),\n    region = tolower(state_full)\n  )\nmap_df &lt;- us_states %&gt;%\n  left_join(state_ref_map, by = \"region\")\n\nggplot(map_df,\n       aes(x = long, y = lat, group = group, fill = ref_per)) +\n  geom_polygon(color = \"white\", linewidth = 0.2) +\n  coord_fixed(1.3) +\n  scale_fill_viridis_c(\n    option = \"C\",  # yellow → purple\n    labels = percent_format(accuracy = 0.01),\n    na.value = \"grey90\",\n    name = \"Referral rate\\n(per student)\"\n  ) +\n  labs(\n    title = \"Referrals to Law Enforcement per Student by State\",\n    x = NULL, y = NULL\n  ) +\n  theme_minimal() +\n  theme(\n    axis.text  = element_blank(),\n    axis.ticks = element_blank(),\n    panel.grid = element_blank()\n  )\n\n\n\n\n\n\n\n\n\n\n\nCode\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(maps)\nlibrary(scales)\n\n# 1. Prep race-level data for mapping\nstate_race_map &lt;- state_race_outcomes %&gt;%\n  mutate(\n    state_full = case_when(\n      state %in% state.abb ~ state.name[match(state, state.abb)],\n      state == \"DC\"        ~ \"District of Columbia\",\n      state == \"PR\"        ~ \"Puerto Rico\",\n      TRUE                 ~ state\n    ),\n    region = tolower(state_full)\n  )\n\n# 2. Base US polygons (lower 48 + AK/HI)\nus_states &lt;- map_data(\"state\")\n\n# 3. Join polygons with justice referral rates\nmap_race_df &lt;- us_states %&gt;%\n  left_join(state_race_map, by = \"region\") %&gt;%\n  # keep only polygons that matched some race (no extra NA facet)\n  filter(!is.na(race_label))\n\n# 4. Faceted choropleth: referrals per student, by race\nggplot(\n  map_race_df,\n  aes(x = long, y = lat, group = group, fill = justice_per_race)\n) +\n  geom_polygon(color = \"white\", linewidth = 0.2) +\n  coord_fixed(1.3) +\n  facet_wrap(~ race_label) +\n  scale_fill_viridis_c(\n    option = \"C\",\n    na.value = \"grey90\",  # states with no data for that race = grey\n    labels = percent_format(accuracy = 0.01),\n    name   = \"Referral rate\\n(per student)\"\n  ) +\n  labs(\n    title = \"Referrals to Law Enforcement per Student by State\\nFaceted by Race\",\n    x = NULL,\n    y = NULL\n  ) +\n  theme_minimal() +\n  theme(\n    axis.text  = element_blank(),\n    axis.ticks = element_blank(),\n    panel.grid = element_blank(),\n    strip.text = element_text(face = \"bold\")\n  )",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Results</span>"
    ]
  },
  {
    "objectID": "data.html#description",
    "href": "data.html#description",
    "title": "2  Data",
    "section": "3.1 Description",
    "text": "3.1 Description",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Data</span>"
    ]
  }
]